<!DOCTYPE html>
<html>

<!-- Mirrored from 127.0.0.1:4567/howto/OpenWRT by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 15 Aug 2022 13:08:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta http-equiv="Content-type" content="text/html;charset=utf-8">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="../gollum/assets/app-309be032396e783b13a47df58f389b7c8e11c2b2d42640560b874f677c25f6e5.css" media="all">
  <link rel="stylesheet" type="text/css" href="../gollum/assets/print-512498c368be0d3fb1ba105dfa84289ae48380ec9fcbef948bd4e23b0b095bfb.css" media="print">

  <link rel="stylesheet" type="text/css" href="../custom.css" media="all">
  

  <script>
  var criticMarkup = '';
	var baseUrl = '';
  var showLocalTime = false;
	var uploadDest = 'uploads';
	var perPageUploads = '';
	if (perPageUploads == 'true') {
	  uploadDest = uploadDest + window.location.pathname.replace(/.*gollum\/[-\w]+\//, "/").replace(/\.[^/.]+$/, "").replace(baseUrl, "")
	}
	  var pageFullPath = 'howto/OpenWRT.md';
    var pageFormat   = 'markdown';

  </script>
  <script src="../gollum/assets/app-f05401ee374f0c7f48fc2bc08e30b4f4db705861fd5895ed70998683b383bfb5.js" type="text/javascript"></script>
  

  <title>OpenWRT</title>
</head>
<body>
<div class="container-lg clearfix">
<div id="wiki-wrapper" class="page">
<div id="head">
	<nav class="TableObject
            actions
            border-bottom
            border-md-0
            p-2
            pt-lg-4
            px-lg-0
            overflow-x-scroll">
  <div class="TableObject-item hide-lg hide-xl">
    <details class="details-reset details-overlay">
      <summary class="btn btn-invisible" aria-haspopup="true">
        <span aria-label="Open menu">☰</span>
      </summary>
    
      <div class="SelectMenu mx-sm-2">
        <div class="SelectMenu-modal">
          <div class="SelectMenu-divider py-3">
            <h2 class="h6">Current Page</h2>
            <div>OpenWRT</div>
          </div>
    
            <a
              class="SelectMenu-item"
              href="../gollum/history/howto/OpenWRT.html"
              role="menuitem"
            >
              <span>History</span>
            </a>
    
    
          <div class="SelectMenu-divider py-3">
            <h2 class="h6">Main Menu</h2>
          </div>
    
          <div class="SelectMenu-list">
            <a class="SelectMenu-item" role="menuitem" href="../index.html">
              Home
            </a>
    
              <a class="SelectMenu-item" role="menuitem" href="../gollum/overview.html">
                Overview
              </a>
    
              <a
                class="SelectMenu-item"
                href="../gollum/latest_changes.html"
                role="menuitem"
              >
                Latest Changes
              </a>
          </div>
        </div>
      </div>
    </details>
  </div>

  <div class="TableObject-item hide-sm hide-md">
    <a class="btn btn-sm" id="minibutton-home" href="../index.html">
      Home
    </a>
  </div>

  <div
    class="TableObject-item TableObject-item--primary px-2"
    
  >
    <form class="search-form" action="http://127.0.0.1:4567/gollum/search" method="get" id="search-form">
    	<input type="text" class="form-control input-block" name="q" id="search-query" placeholder="Search" aria-label="Search site" autocomplete="off">
    </form>  </div>

  <div class="TableObject-item hide-sm hide-md">
    <div class="BtnGroup d-flex">
        <a
          class="btn BtnGroup-item btn-sm"
          href="../gollum/overview.html"
          id="minibutton-overview"
        >
          Overview
        </a>

        <a
          class="btn BtnGroup-item btn-sm"
          href="../gollum/latest_changes.html"
          id="minibutton-latest-changes"
        >
          Latest Changes
        </a>
    </div>
  </div>

  <div class="TableObject-item px-2">
    <div class="BtnGroup d-flex">
        <a
          class="btn BtnGroup-item btn-sm hide-sm hide-md"
          href="../gollum/history/howto/OpenWRT.md/index.html"
          id="minibutton-history"
        >
          History
        </a>

    </div>
  </div>

</nav>

</div>

<div id="wiki-content" class="px-2 px-lg-0">
  <h1 class="header-title text-center text-md-left pt-4">
    OpenWRT
  </h1>
	<div class="breadcrumb"><nav aria-label="Breadcrumb"><ol>
<li class="breadcrumb-item"><a href="../gollum/overview/howto/index.html">howto</a></li>
</ol></nav></div>

	<div class="has-header has-footer has-sidebar has-rightbar">
	  <div id="wiki-body" class="gollum-markdown-content">
	    <div id="wiki-header" class="gollum-markdown-content">
	      <div id="header-content" class="markdown-body">
	        <p><a href="../index.html" rel="nofollow"><img src="../dn42.png" alt="dn42" /></a></p>

	      </div>
	    </div>
	    <div class="main-content clearfix container-lg">
	      <div class="markdown-body  float-md-left col-md-9" >
	        
	        <h1><a class="anchor" id="dn42-on-openwrt" href="#dn42-on-openwrt"></a>dn42 on OpenWRT</h1>

<p>This page gives hints on how to participate to dn42 with an OpenWRT router. It assumes Attitude Adjustment (12.09), but you can adapt it for other versions.</p>

<p>The intended target is a home router, acting as the default gateway for its LAN clients. The goal is to have one or more dn42 peers, announce the LAN subnet with BGP, and thus transparently provide dn42 access to the LAN clients.</p>

<p>This documentation assumes that the LAN is addressed in the dn42 space (<code>172.22.0.0/15</code>), but it's not a big deal to add NAT if it's not.</p>

<h2><a class="anchor" id="initial-configuration" href="#initial-configuration"></a>Initial configuration</h2>

<h2><a class="anchor" id="peerings" href="#peerings"></a>Peerings</h2>

<p>Nothing fancy: use GRE tunnels, openvpn, anything. Don't forget to install the relevant packages with <code>opkg</code> (<code>kmod-gre</code> for instance).</p>

<p>You can't manage GRE tunnels with OpenWRT, so just create them in <code>/etc/rc.local</code> (and assign addresses if needed).</p>

<h2><a class="anchor" id="bgp" href="#bgp"></a>BGP</h2>

<p><code>quagga</code> and <code>bird</code> are both packaged in OpenWRT. Note that quagga is split in many packages, you probably need <code>quagga-bgpd</code>, <code>quagga-vtysh</code> and <code>quagga-zebra</code>.</p>

<p>Of course, you should announce the prefix of your home network.</p>

<h2><a class="anchor" id="interface-definition" href="#interface-definition"></a>Interface definition</h2>

<p>This is needed so that OpenWRT is aware of the new interfaces (for firewall and stuff).</p>

<p>In <code>/etc/config/network</code>, add entries for each dn42 interface:</p>

<pre><code>config interface dn42peer1
    option ifname tun-peer1
    option proto none
</code></pre>

<h2><a class="anchor" id="firewall" href="#firewall"></a>Firewall</h2>

<p>There are two goals:</p>

<ul>
<li>Allowing traffic from LAN to dn42 (and maybe from dn42 to LAN too)</li>
<li>If you have more than one peer, allowing traffic from dn42 to dn42 (forwarding)</li>
</ul>

<p>Everything is done in <code>/etc/config/firewall</code>.</p>

<h3><a class="anchor" id="zone-declaration" href="#zone-declaration"></a>Zone declaration</h3>

<pre><code>config zone
    option name             dn42
    option network          'dn42peer1 dn42peer2 dn42peer3'
    option input            REJECT
    option output           ACCEPT
    option forward          REJECT
</code></pre>

<p>If you need to NAT your home network into dn42, you probably just need to add: </p>

<pre><code>    option masq             1
</code></pre>

<h3><a class="anchor" id="dn42-lan-forwarding" href="#dn42-lan-forwarding"></a>dn42 ↔ LAN forwarding</h3>

<pre><code>config forwarding                   
    option src              lan
    option dest             dn42
</code></pre>

<p>If you're confident enough, you can also forward dn42 into your LAN:</p>

<pre><code>config forwarding                   
    option src              dn42
    option dest             lan
</code></pre>

<p>Or you can forward only certain ports, to certain hosts, etc (standard <code>config rule</code> stuff)</p>

<h3><a class="anchor" id="dn42-dn42-forwarding" href="#dn42-dn42-forwarding"></a>dn42 ↔ dn42 forwarding</h3>

<p>This is more tricky. In theory, all you have to do is to set</p>

<pre><code>    option forward          ACCEPT
</code></pre>

<p>in the definition of the zone. However, due to a bug in Attitude Adjustment (see <a href="https://dev.openwrt.org/ticket/12945">https://dev.openwrt.org/ticket/12945</a>), this will allow forwarding <strong>everything everywhere</strong>.</p>

<p>You have to use this patch: <a href="https://dev.openwrt.org/changeset/35484">https://dev.openwrt.org/changeset/35484</a> (monkeypatching the relevant files in <code>/lib</code> should work).</p>

<h2><a class="anchor" id="dns" href="#dns"></a>DNS</h2>

<p>See <a href="../services/dns/Configuration.html">DNS Configuration</a>. This will use the anycast dn42 DNS server to resolve <code>dn42</code> and relevant reverse domains.</p>

	      </div>
          <div id="wiki-sidebar" class="Box Box--condensed float-md-left col-md-3">
	        <div id="sidebar-content" class="gollum-markdown-content markdown-body px-4">
	          <ul>
<li>
<a href="../Home.html" rel="nofollow">Home</a>

<ul>
<li><a href="Getting-Started.html" rel="nofollow">Getting Started</a></li>
<li><a href="Registry-Authentication.html" rel="nofollow">Registry Authentication</a></li>
<li><a href="Address-Space.html" rel="nofollow">Address Space</a></li>
<li><a href="Bird-communities.html" rel="nofollow">BGP communities</a></li>
<li><a href="../FAQ.html" rel="nofollow">FAQ</a></li>
</ul>
</li>
</ul>

<ul>
<li>
<p>How-To</p>

<ul>
<li><a href="wireguard.html" rel="nofollow">Wireguard</a></li>
<li><a href="openvpn.html" rel="nofollow">Openvpn</a></li>
<li><a href="IPsec-with-PublicKeys.html" rel="nofollow">IPsec With Public Keys</a></li>
<li><a href="tinc.html" rel="nofollow">Tinc</a></li>
<li><a href="GRE-on-FreeBSD.html" rel="nofollow">GRE on FreeBSD</a></li>
<li><a href="GRE-on-OpenBSD.html" rel="nofollow">GRE on OpenBSD</a></li>
<li><a href="IPv6-Multicast.html" rel="nofollow">IPv6 Multicast (PIM-SM)</a></li>
<li>
<a href="Bird.html" rel="nofollow">Bird</a> / <a href="Bird2.html" rel="nofollow">Bird2</a>
</li>
<li><a href="Quagga.html" rel="nofollow">Quagga</a></li>
<li><a href="OpenBGPD.html" rel="nofollow">OpenBGPD</a></li>
<li><a href="mikrotik.html" rel="nofollow">Mikrotik RouterOS</a></li>
<li><a href="EdgeOS-Config.html" rel="nofollow">EdgeRouter</a></li>
<li><a href="Static-routes-on-Windows.html" rel="nofollow">Static routes on Windows</a></li>
<li><a href="networksettings.html" rel="nofollow">Universal Network Requirements</a></li>
<li><a href="vyos.html" rel="nofollow">VyOS</a></li>
<li><a href="nixos.html" rel="nofollow">NixOS</a></li>
</ul>
</li>
<li>
<p>Services</p>

<ul>
<li><a href="../services/IRC.html" rel="nofollow">IRC</a></li>
<li><a href="../services/Whois.html" rel="nofollow">Whois registry</a></li>
<li><a href="../services/DNS.html" rel="nofollow">DNS</a></li>
<li><a href="../services/Clearnet-Domains.html" rel="nofollow">Public DNS</a></li>
<li><a href="../services/Looking-Glasses.html" rel="nofollow">Looking Glasses</a></li>
<li><a href="../services/Automatic-Peering.html" rel="nofollow">Automatic Peering</a></li>
<li><a href="../services/Repository-Mirrors.html" rel="nofollow">Repository Mirrors</a></li>
<li><a href="../services/Distributed-Wiki.html" rel="nofollow">Distributed Wiki</a></li>
<li><a href="../services/Certificate-Authority.html" rel="nofollow">Certificate Authority</a></li>
<li><a href="../services/Route-Collector.html" rel="nofollow">Route Collector</a></li>
</ul>
</li>
<li>
<p>Internal</p>

<ul>
<li><a href="../internal/Internal-Services.html" rel="nofollow">Internal services</a></li>
<li><a href="../internal/Interconnections.html" rel="nofollow">Interconnections</a></li>
<li><a href="../internal/APIs.html" rel="nofollow">APIs</a></li>
<li>
<a href="../internal/ShowAndTell.html" rel="nofollow">Show and Tell</a><br />
</li>
<li><a href="../internal/Historical-Services.html" rel="nofollow">Historical services</a></li>
</ul>
</li>
<li>
<p>External Tools</p>

<ul>
<li><a href="https://paste.dn42.us/" rel="nofollow">Paste Board</a></li>
<li><a href="https://git.dn42.dev/" rel="nofollow">Git Repositories</a></li>
</ul>
</li>
</ul>

<hr />

	        </div>
	      </div>
	    </div>
	  </div>
	  <div id="wiki-footer" class="gollum-markdown-content my-2">
	    <div id="footer-content" class="Box Box-condensed markdown-body px-4">
	      <p>Hosted by: <a href="mailto:xuu@sour.is" rel="nofollow">xuu</a>, <a href="mailto:nurtic-vibe@grmml.net" rel="nofollow">nurtic-vibe</a>, <a href="mailto:tom@xcv.vc" rel="nofollow">toBee</a>, <a href="mailto:dn42@burble.com" rel="nofollow">burble</a> | Accessible via: <a href="https://wiki.dn42/" rel="nofollow">dn42</a>, <a href="https://dn42.eu/" rel="nofollow">dn42.eu</a>, <a href="https://dn42.dev/" rel="nofollow">dn42.dev</a></p>

	    </div>
	  </div>


	</div>


	<div id="footer" class="pt-4">
		  <p id="last-edit"><div class="dotted-spinner hidden"></div> <a id="page-info-toggle" data-pagepath="howto/OpenWRT.md">When was this page last modified?</a></p>
	</div>


</div>

<form name="rename" method="POST" action="http://127.0.0.1:4567/gollum/rename/howto/OpenWRT.md">
  <input type="hidden" name="rename"/>
  <input type="hidden" name="message"/>
</form>

</div>
</div>
</body>

<!-- Mirrored from 127.0.0.1:4567/howto/OpenWRT by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 15 Aug 2022 13:08:50 GMT -->
</html>
